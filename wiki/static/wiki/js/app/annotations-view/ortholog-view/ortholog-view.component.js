angular.module('orthologView').component('orthologView',{bindings:{locusTag:'<',taxId:'<'},controller:"orthologCtrl",templateUrl:'/static/wiki/js/angular_templates/ortholog-view.html'}).factory('alignOrthologData',function($http,$timeout){var align=function(data,ctrl){$http.get("alignOrthologs?sequence="+encodeURIComponent(data.join("\n"))+"&length="+encodeURIComponent(data.length)).then(function(response){var id=response.data.id;console.log("Job ID:"+id);checkId(id,ctrl);},function(response){ctrl.aligning=false;console.log("POST TO MUSCLE Error"+response.status);console.log(response);var seqs=msa.io.fasta.parse(data.join("\n"));var settings={el:document.getElementById("msaDiv"),seqs:seqs};var m=new msa.msa(settings);m.render();});};var checkId=function(id,ctrl){$http.get('http://www.ebi.ac.uk/Tools/services/rest/muscle/status/'+id).then(function(response){console.log(response.data);if(response.data=="RUNNING"){$timeout(checkId(id,ctrl),2000);return;}if(response.data=="FINISHED"){ctrl.aligning=false;var settings={el:document.getElementById("msaDiv"),};var m=new msa.msa(settings);m.u.file.importURL("http://www.ebi.ac.uk/Tools/services/rest/muscle/result/"+id+"/aln-fasta",function(){m.render();});}else{console.log("ERROR: "+response.data);ctrl.aligning=false;}});};return{align:align}}).factory('geneSequenceData',function($http,$q){var getSequence=function(value){var deferred=$q.defer();$http.get('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=gene&term='+value).success(function(response){var xml=response;if(xml.includes("<Id>")){var id=xml.substring(xml.indexOf("<Id>")+4,xml.indexOf("</Id>"));$http.get('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=gene&id='+id).success(function(resp){xml=resp;var start=parseInt(xml.substring(xml.indexOf("<ChrStart>")+10,xml.indexOf("</ChrStart>")))+1;var stop=parseInt(xml.substring(xml.indexOf("<ChrStop>")+9,xml.indexOf("</ChrStop>")))+1;var accession=xml.substring(xml.indexOf("<ChrAccVer>")+11,xml.indexOf("</ChrAccVer>"));var strand=1;if(start>stop){strand=2;var temp=start;start=stop;stop=temp;}$http.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id="+accession+"&seq_start="+start+"&seq_stop="+stop+"&strand="+strand+"&rettype=fasta").success(function(r){var first="";if(r.indexOf("Chlamydia")!=-1){first=">"+r.substring(r.indexOf("Chlamydia")+10,r.indexOf("\n")+1);}else{first=">"+r.substring(r.indexOf("Chlamydophila")+14,r.indexOf("\n")+1);}first=first.replace(" ","_").replace(","," ");first=first.substring(0,2).toUpperCase()+first.substring(2);var body=r.substring(r.indexOf("\n")+1,r.length).replace(/\n/g,"");deferred.resolve(first+body);}).error(function(response){deferred.reject(response);});}).error(function(response){deferred.reject(response);});}});return deferred.promise;};return{getSequence:getSequence}}).controller('orthologCtrl',function(orthoData,geneSequenceData,alignOrthologData){var ctrl=this;ctrl.alignMessage="Aligning Orthologs. Please be patient.";ctrl.data={};ctrl.projection={}
orthoData.getOrthologs(ctrl.locusTag).then(function(response){ctrl.data[ctrl.taxId]=ctrl.locusTag;ctrl.projection[ctrl.locusTag]=true;angular.forEach(response.results.bindings,function(obj){var tax=obj.orthoTaxid.value;var tag=obj.orthoLocusTag.value;ctrl.data[tax]=tag;ctrl.hasOrthologs=true;ctrl.projection[tag]=true;});});ctrl.tSettings={"strain":true,"tax":true,"cLocus":true,"dLocus":false,"identity":false,"length":false,"eval":false,"ref":true,"align":true};ctrl.citation=false;ctrl.select=function(checked,value){ctrl.projection[value]=checked;};ctrl.updatePanel=function(){var data=[];var index=0;angular.forEach(ctrl.projection,function(value,key){if(value){var promise=geneSequenceData.getSequence(key);promise.then(function(seq){index++;data.push(seq);if(index==Object.keys(ctrl.projection).length){ctrl.aligning=true;alignOrthologData.align(data,ctrl);ctrl.citation=true;}},function(error){index++;ctrl.aligning=false;});}else{index++;}});};});