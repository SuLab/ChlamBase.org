angular.module("alignmentView").controller("alignmentCtrl",["orthoData","geneSequenceData","alignOrthologData","proteinSequenceData",function(e,r,a,s){"use strict";var o=this;o.projection={},o.type="dna",o.alignMessage="Aligning Orthologs. Please be patient.",o.citation=!1,o.isRendered=!1,o.data={},e.getOrthologs(o.locusTag).then(function(e){angular.forEach(e.results.bindings,function(e){var n=e.orthoTaxid.value,t=e.orthoLocusTag.value;o.hasOrthologs=!0,o.projection[n]=!0;var i=e.refseq?e.refseq.value:"";o.data[n]=[t,i]})}),o.select=function(e,n){o.projection[n]=e},o.alignData=function(){var t=[],i=0;angular.forEach(o.projection,function(e,n){e?("dna"==o.type?r.getSequence(o.data[n][0]):s.getSequence(o.data[n][1])).then(function(e){i++,t.push(e),i==Object.keys(o.projection).length&&(o.aligning=!0,a.align(t,o),o.citation=!0)},function(e){i++,o.aligning=!1}):i++})}}]).factory("geneSequenceData",["$http","$q",function(c,n){"use strict";return{getSequence:function(e){var o=n.defer();return c.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=gene&term="+e).success(function(e){var s=e;if(s.includes("<Id>")){var n=s.substring(s.indexOf("<Id>")+4,s.indexOf("</Id>"));c.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=gene&id="+n).success(function(e){s=e;var n=parseInt(s.substring(s.indexOf("<ChrStart>")+10,s.indexOf("</ChrStart>")))+1,t=parseInt(s.substring(s.indexOf("<ChrStop>")+9,s.indexOf("</ChrStop>")))+1,i=s.substring(s.indexOf("<ChrAccVer>")+11,s.indexOf("</ChrAccVer>")),r=1;if(t<n){r=2;var a=n;n=t,t=a}c.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id="+i+"&seq_start="+n+"&seq_stop="+t+"&strand="+r+"&rettype=fasta").success(function(e){var n="";n=(n=(n=-1!=e.indexOf("Chlamydia")?">"+e.substring(e.indexOf("Chlamydia")+10,e.indexOf("\n")+1):">"+e.substring(e.indexOf("Chlamydophila")+14,e.indexOf("\n")+1)).replace(" ","_").replace(","," ")).substring(0,2).toUpperCase()+n.substring(2);var t=e.substring(e.indexOf("\n")+1,e.length).replace(/\n/g,"");o.resolve(n+t)}).error(function(e){o.reject(e)})}).error(function(e){o.reject(e)})}}),o.promise}}}]).factory("proteinSequenceData",["$http","$q",function(n,t){"use strict";return{getSequence:function(e){var i=t.defer();return e?n.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=protein&id="+e+"&rettype=fasta").then(function(e){var n=e.data,t=">"+n.substring(n.indexOf("[")+1,n.indexOf("]")).replace("Chlamydia ","").replace(" ","_")+"\n"+n.substring(n.indexOf("\n")).replace(/\n/g,"");i.resolve(t)},function(e){console.log("Error reading protein sequence"),i.reject(e)}):(console.log("No Ref Seq ID"),i.reject()),i.promise}}}]).factory("alignOrthologData",["$http","$timeout","$sce",function(e,a,s){"use strict";var o=function(i,r){e.get("https://www.ebi.ac.uk/Tools/services/rest/muscle/status/"+i).then(function(e){if(console.log(e.data),"RUNNING"!=e.data)if("FINISHED"==e.data){r.aligning=!1;var n={el:document.getElementById("msaDiv")},t=new msa.msa(n);t.u.file.importURL("https://www.ebi.ac.uk/Tools/services/rest/muscle/result/"+i+"/aln-fasta",function(){t.render()}),r.isRendered=!0,r.alignmentURL=s.trustAsResourceUrl("https://www.ebi.ac.uk/Tools/services/rest/muscle/result/"+i+"/aln-fasta")}else console.log("ERROR: "+e.data),r.aligning=!1;else a(o(i,r),2e3)})};return{align:function(i,r){e.get("alignOrthologs?sequence="+encodeURIComponent(i.join("\n"))+"&length="+encodeURIComponent(i.length)).then(function(e){var n=e.data.id;console.log("Job ID:"+n),o(n,r)},function(e){r.aligning=!1,console.log("POST TO MUSCLE Error"+e.status),console.log(e);var n=msa.io.fasta.parse(i.join("\n")),t={el:document.getElementById("msaDiv"),seqs:n};new msa.msa(t).render(),r.isRendered=!0})}}}]).component("alignmentView",{controller:"alignmentCtrl",templateUrl:"/static/wiki/js/angular_templates/alignment-view.html",bindings:{locusTag:"<",taxId:"<",allorggenes:"<"}});