angular.module("alignmentView").controller("alignmentCtrl",function(orthoData,geneSequenceData,alignOrthologData){"use strict";var ctrl=this;ctrl.projection={},ctrl.type="dna",ctrl.alignMessage="Aligning Orthologs. Please be patient.",ctrl.citation=!1,ctrl.isRendered=!1,ctrl.data={},orthoData.getOrthologs(ctrl.locusTag).then(function(response){angular.forEach(response.results.bindings,function(obj){var tax=obj.orthoTaxid.value,tag=obj.orthoLocusTag.value;ctrl.hasOrthologs=!0,ctrl.projection[tag]=!0,ctrl.data[tax]=tag})}),ctrl.select=function(checked,value){ctrl.projection[value]=checked},ctrl.alignData=function(){var data=[],index=0;angular.forEach(ctrl.projection,function(value,key){value?geneSequenceData.getSequence(key).then(function(seq){index++,data.push(seq),index==Object.keys(ctrl.projection).length&&(ctrl.aligning=!0,alignOrthologData.align(data,ctrl),ctrl.citation=!0)},function(error){index++,ctrl.aligning=!1}):index++})}}).factory("geneSequenceData",function($http,$q){"use strict";return{getSequence:function(value){var deferred=$q.defer();return $http.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=gene&term="+value).success(function(response){var xml=response;if(xml.includes("<Id>")){var id=xml.substring(xml.indexOf("<Id>")+4,xml.indexOf("</Id>"));$http.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=gene&id="+id).success(function(resp){xml=resp;var start=parseInt(xml.substring(xml.indexOf("<ChrStart>")+10,xml.indexOf("</ChrStart>")))+1,stop=parseInt(xml.substring(xml.indexOf("<ChrStop>")+9,xml.indexOf("</ChrStop>")))+1,accession=xml.substring(xml.indexOf("<ChrAccVer>")+11,xml.indexOf("</ChrAccVer>")),strand=1;if(stop<start){strand=2;var temp=start;start=stop,stop=temp}$http.get("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id="+accession+"&seq_start="+start+"&seq_stop="+stop+"&strand="+strand+"&rettype=fasta").success(function(r){var first="";first=(first=(first=-1!=r.indexOf("Chlamydia")?">"+r.substring(r.indexOf("Chlamydia")+10,r.indexOf("\n")+1):">"+r.substring(r.indexOf("Chlamydophila")+14,r.indexOf("\n")+1)).replace(" ","_").replace(","," ")).substring(0,2).toUpperCase()+first.substring(2);var body=r.substring(r.indexOf("\n")+1,r.length).replace(/\n/g,"");deferred.resolve(first+body)}).error(function(response){deferred.reject(response)})}).error(function(response){deferred.reject(response)})}}),deferred.promise}}}).factory("alignOrthologData",function($http,$timeout){"use strict";var checkId=function(id,ctrl){$http.get("https://www.ebi.ac.uk/Tools/services/rest/muscle/status/"+id).then(function(response){if(console.log(response.data),"RUNNING"!=response.data)if("FINISHED"==response.data){ctrl.aligning=!1;var settings={el:document.getElementById("msaDiv")},m=new msa.msa(settings);m.u.file.importURL("https://www.ebi.ac.uk/Tools/services/rest/muscle/result/"+id+"/aln-fasta",function(){m.render()}),ctrl.isRendered=!0}else console.log("ERROR: "+response.data),ctrl.aligning=!1;else $timeout(checkId(id,ctrl),2e3)})};return{align:function(data,ctrl){$http.get("alignOrthologs?sequence="+encodeURIComponent(data.join("\n"))+"&length="+encodeURIComponent(data.length)).then(function(response){var id=response.data.id;console.log("Job ID:"+id),checkId(id,ctrl)},function(response){ctrl.aligning=!1,console.log("POST TO MUSCLE Error"+response.status),console.log(response);var seqs=msa.io.fasta.parse(data.join("\n")),settings={el:document.getElementById("msaDiv"),seqs:seqs};new msa.msa(settings).render(),ctrl.isRendered=!0})}}}).component("alignmentView",{controller:"alignmentCtrl",templateUrl:"/static/wiki/js/angular_templates/alignment-view.html",bindings:{locusTag:"<",taxId:"<",allorggenes:"<"}});