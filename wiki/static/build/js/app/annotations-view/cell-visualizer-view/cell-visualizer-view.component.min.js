angular.module("cellVisualizer").controller("cellVisualizerCtrl",["geneOntologyService","$timeout",function(t,e){"use strict";var i=this;function l(n){var l=document.getElementById("cell-svg").contentDocument,o=[];o=t.isInclusion(n)?l.getElementsByClassName("inclusion"):l.getElementsByClassName(t.getClass(n)),e(function(){if(i.pending--,t.isPlasmaMembrane(n))(o[0].style.fill="#4784FF")!=l.getElementsByClassName("cytoplasm")[0].style.fill&&(l.getElementsByClassName("cytoplasm")[0].style.fill="#FFFFFF");else if(t.isInclusion(n))t.isInclusionMembrane(n)?o[0].style.stroke="#4784FF":o[0].style.fill="#4784FF";else for(var e=0;e<o.length;e++)o[e].style.fill="#4784FF";0==i.pending&&(i.loading=!1)},1e3)}i.status="Loading Component Viewer...",i.loading=!0,i.$onChanges=function(){i.cellComp&&(i.pending=i.cellComp.length,angular.forEach(i.cellComp,function(e){var n=e.goID.value.replace(":","_");i.highlight(n)}),0==i.pending&&(i.loading=!1,i.status="No Components to Show"))},this.displayCell=!1,this.highlight=function(n){t.isValid(n)?(i.displayCell=!0,l(n)):t.getParent(n).then(function(e){i.displayCell=!0,l(e)},function(e){console.log("No compatible parent  found for "+n),console.log(e),i.pending--,0==i.pending&&(i.loading=!1,i.status="No Components to Show")})}}]).service("geneOntologyService",["$http","$q",function(n,l){var o={GO_0044177:"golgi",GO_0044174:"endosome",GO_0120149:"peroxisome",GO_0042025:"nucleus",GO_0033650:"mitochondria",GO_0044165:"er",GO_0140221:"inclusion_membrane",GO_0140222:"inclusion_lumen",BTO_0001172:"rb",BTO_0000377:"eb",GO_0044187:"lysosome",GO_0044186:"ld",GO_0120148:"centrosome",GO_0044163:"cytoskeleton",GO_0020002:"plasma_membrane",GO_0030430:"cytoplasm"},i=function(e){return!!o[e]};return{getParent:function(o){var t=l.defer(),e=encodeURIComponent(encodeURIComponent("https://purl.obolibrary.org/obo/"+o));return n.get("https://www.ebi.ac.uk/ols/api/ontologies/go/terms/"+e+"/hierarchicalAncestors").success(function(e){if(e._embedded)for(var n=0;n<e._embedded.terms.length;n++){var l=e._embedded.terms[n];if(i(l.short_form))return console.log("Go term "+o+" has parent "+l.label),void t.resolve(l.short_form)}t.reject(e)}).error(function(e){t.reject(e)}),t.promise},isValid:i,getClass:function(e){return o[e]},isPlasmaMembrane:function(e){return"plasma_membrane"==o[e]},isInclusion:function(e){return"inclusion_membrane"==o[e]||"inclusion_lumen"==o[e]},isInclusionMembrane:function(e){return"inclusion_membrane"==o[e]}}}]).component("cellVisualizer",{controller:"cellVisualizerCtrl",templateUrl:"/static/wiki/js/angular_templates/cell-visualizer-view.html",bindings:{cellComp:"<"}});