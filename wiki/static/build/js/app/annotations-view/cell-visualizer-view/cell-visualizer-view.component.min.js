angular.module("cellVisualizer").controller("cellVisualizerCtrl",function(geneOntologyService,$timeout){"use strict";var ctrl=this;function fill(goTerm){var svgDoc=document.getElementById("cell-svg").contentDocument,paths=[];paths=geneOntologyService.isInclusion(goTerm)?svgDoc.getElementsByClassName("inclusion"):svgDoc.getElementsByClassName(geneOntologyService.getClass(goTerm)),$timeout(function(){if(ctrl.pending--,geneOntologyService.isPlasmaMembrane(goTerm))(paths[0].style.fill="#4784FF")!=svgDoc.getElementsByClassName("cytoplasm")[0].style.fill&&(svgDoc.getElementsByClassName("cytoplasm")[0].style.fill="#FFFFFF");else if(geneOntologyService.isInclusion(goTerm))geneOntologyService.isInclusionMembrane(goTerm)?paths[0].style.stroke="#4784FF":paths[0].style.fill="#4784FF";else for(var i=0;i<paths.length;i++)paths[i].style.fill="#4784FF";0==ctrl.pending&&(ctrl.loading=!1)},1e3)}ctrl.status="Loading Component Viewer...",ctrl.loading=!0,ctrl.$onChanges=function(){ctrl.cellComp&&(ctrl.pending=ctrl.cellComp.length,angular.forEach(ctrl.cellComp,function(value){var id=value.goID.value.replace(":","_");ctrl.highlight(id)}),0==ctrl.pending&&(ctrl.loading=!1,ctrl.status="No Components to Show"))},this.displayCell=!1,this.highlight=function(goTerm){geneOntologyService.isValid(goTerm)?(ctrl.displayCell=!0,fill(goTerm)):geneOntologyService.getParent(goTerm).then(function(response){ctrl.displayCell=!0,fill(response)},function(response){console.log("No compatible parent  found for "+goTerm),console.log(response),ctrl.pending--})}}).service("geneOntologyService",function($http,$q){var go_map={GO_0044177:"golgi",GO_0044174:"endosome",GO_0120149:"peroxisome",GO_0042025:"nucleus",GO_0033650:"mitochondria",GO_0044165:"er",GO_0140221:"inclusion_membrane",GO_0140222:"inclusion_lumen",BTO_0001172:"rb",BTO_0000377:"eb",GO_0044187:"lysosome",GO_0044186:"ld",GO_0120148:"centrosome",GO_0044163:"cytoskeleton",GO_0020002:"plasma_membrane",GO_0030430:"cytoplasm"},isValid=function(goTerm){return!!go_map[goTerm]};return{getParent:function(term){var deferred=$q.defer(),iri=encodeURIComponent(encodeURIComponent("https://purl.obolibrary.org/obo/"+term));return $http.get("https://www.ebi.ac.uk/ols/api/ontologies/go/terms/"+iri+"/hierarchicalAncestors").success(function(data){if(data._embedded)for(var i=0;i<data._embedded.terms.length;i++){var next=data._embedded.terms[i];if(isValid(next.short_form))return console.log("Go term "+term+" has parent "+next.label),void deferred.resolve(next.short_form)}deferred.reject(data)}).error(function(response){deferred.reject(response)}),deferred.promise},isValid:isValid,getClass:function(goTerm){return go_map[goTerm]},isPlasmaMembrane:function(goTerm){return"plasma_membrane"==go_map[goTerm]},isInclusion:function(goTerm){return"inclusion_membrane"==go_map[goTerm]||"inclusion_lumen"==go_map[goTerm]},isInclusionMembrane:function(goTerm){return"inclusion_membrane"==go_map[goTerm]}}}).component("cellVisualizer",{controller:"cellVisualizerCtrl",templateUrl:"/static/wiki/js/angular_templates/cell-visualizer-view.html",bindings:{cellComp:"<"}});